<!DOCTYPE html>
<!-- saved from url=(0077)http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <title>Building a spell checker for search in Umbraco - Lars-Erik's blog</title>

        <meta name="description" content="Spell checking is part of what makes good search engines good. Building one is actually quite easy if you lean on Lucene Contrib. In this article we&#39;ll combine Examine with Lucene&#39;s SpellChecker and create some meaningful feedback to the user.">
    <link type="application/rsd+xml" rel="edituri" title="RSD" href="http://blog.aabech.no/blog/rsd/1059">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.aabech.no/blog/wlwmanifest/1059">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="http://blog.aabech.no/blog/rss">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link rel="canonical" href="http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/">

    <link rel="stylesheet" href="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/font-awesome.min.css">
    <link rel="stylesheet" href="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/css">
    <script async="" src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/analytics.js.download"></script><script type="text/javascript" src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/jquery.min.js.download"></script>



    <link href="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/DependencyHandler.axd" type="text/css" rel="stylesheet">
<script type="text/javascript" async="" src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/embed.js.download"></script><link rel="stylesheet" type="text/css" href="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/sons-of-obsidian.css"><script src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/alfie.f51946af45e0b561c60f768335c9eb79.js.download" async="" charset="UTF-8"></script></head>
<body class="post-template">

    <header id="site-head">

            <a id="blog-logo" href="http://blog.aabech.no/blog/">
                <div class="bloglogo" style="background: url(/media/1002/umbarcelonajpeg.jpg?mode=max&amp;rnd=131072072810000000)"></div>
            </a>

        <h1 class="blog-title">
            <a href="http://blog.aabech.no/blog/">
                Lars-Erik's blog
            </a>
        </h1>

        <h2 class="blog-description">
    Ramblings about Umbraco, .net and JavaScript development. With a sprinkle of other stuff.
</h2>
        <nav class="menu" role="nav">
    <ul>
        <li><a href="http://blog.aabech.no/blog/categories">Archive</a></li>
        <li><a href="http://blog.aabech.no/blog/tags">Tags</a></li>
        <li>
            <div class="articulate-search">
    <form method="get" action="http://blog.aabech.no/blog/search">
        <input type="text" name="term" placeholder="Search...">
        <button type="submit" class="fa fa-search fa"></button>
    </form>
</div>
        </li>
    </ul>
</nav>

    </header>

    

<main class="content" role="main">

    <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
        <meta itemprop="url" content="http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/">
        <meta itemprop="mainEntityOfPage" content="http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/">
        <header>
            <h1 class="post-title" itemprop="headline">Building a spell checker for search in Umbraco</h1>
            <meta itemprop="name" content="Building a spell checker for search in Umbraco">
            <div class="post-meta">
                <time datetime="2016-05-13" itemprop="datePublished">
                    Friday, May 13, 2016
                </time>
                <time datetime="2016-05-13" itemprop="dateModified"></time>
                    <div class="post-meta tags">

            <div>
                Categories

                    <a href="http://blog.aabech.no/blog/categories/umbraco">umbraco</a>
                        <span>, </span>
                    <a href="http://blog.aabech.no/blog/categories/search">search</a>
                        <span>, </span>
                    <a href="http://blog.aabech.no/blog/categories/lucene">lucene</a>
                        <span>, </span>
                    <a href="http://blog.aabech.no/blog/categories/examine">examine</a>
            </div>

    </div>

            </div>
        </header>

        <section class="post-content" itemprop="articleBody">



            <p>I spent the day building a spell checker for a search UI I've been improving. Turns out it was pretty easy when leaning on <a href="https://lucenenet.apache.org/index.html">Lucene.Net Contrib</a>.
I'll show you the gist of it in this article.</p>
<p>Make sure you have some nice proofed data to work with tough. While writing the tests for my checker, I kept getting silly suggestions and wrong results. Turned out the data itself had quite a few typos. On the bright side, it allowed us to fix the typos.</p>
<h3>Building a dictionary</h3>
<p>So the first thing you need to provide spell checking is a dictionary. For my solution I went with using all the words that exists in the site so I wouldn't suggest words that don't have results. We already have something that provides this functionality, namely <a href="https://github.com/Shazwazza/Examine">Examine</a>. Examine lets you add indexes with custom indexers, and that's a perfect fit for our needs. This dictionary however only needs one field: word.</p>
<p>Here's the basic code for an indexer that indexes all the words in a site:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SpellCheckIndexer</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="typ">BaseUmbracoIndexer</span></code></li><li class="L1"><code class=""><span class="pun">{</span></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="com">// May be extended to find words from more types</span></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">override</span><span class="pln"> </span><span class="typ">IEnumerable</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">SupportedTypes</span></code></li><li class="L4"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="kwd">get</span></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="pun">{</span></code></li><li class="L7"><code class=""><span class="pln">            </span><span class="kwd">yield</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">IndexTypes</span><span class="pun">.</span><span class="typ">Content</span><span class="pun">;</span></code></li><li class="L8"><code class=""><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L0"><code class=""></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">override</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">AddDocument</span><span class="pun">(</span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">&gt;</span><span class="pln"> fields</span><span class="pun">,</span><span class="pln"> </span><span class="typ">IndexWriter</span><span class="pln"> writer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> nodeId</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> type</span><span class="pun">)</span></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L3"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> doc </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Document</span><span class="pun">();</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="typ">List</span><span class="str">&lt;string&gt;</span><span class="pln"> cleanValues </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">List</span><span class="str">&lt;string&gt;</span><span class="pun">();</span></code></li><li class="L5"><code class=""></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="com">// This example just cleans HTML, but you could easily clean up json too</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="typ">CollectCleanValues</span><span class="pun">(</span><span class="pln">fields</span><span class="pun">,</span><span class="pln"> cleanValues</span><span class="pun">);</span></code></li><li class="L8"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> allWords </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="str">" "</span><span class="pun">,</span><span class="pln"> cleanValues</span><span class="pun">);</span></code></li><li class="L9"><code class=""></code></li><li class="L0"><code class=""><span class="pln">        </span><span class="com">// Make sure you don't stem the words. You want the full terms, but no whitespace or punctuation.</span></code></li><li class="L1"><code class=""><span class="pln">        doc</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Field</span><span class="pun">(</span><span class="str">"word"</span><span class="pun">,</span><span class="pln"> allWords</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Field</span><span class="pun">.</span><span class="typ">Store</span><span class="pun">.</span><span class="pln">NO</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Field</span><span class="pun">.</span><span class="typ">Index</span><span class="pun">.</span><span class="pln">ANALYZED</span><span class="pun">));</span></code></li><li class="L2"><code class=""></code></li><li class="L3"><code class=""><span class="pln">        writer</span><span class="pun">.</span><span class="typ">UpdateDocument</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Term</span><span class="pun">(</span><span class="str">"__id"</span><span class="pun">,</span><span class="pln"> nodeId</span><span class="pun">.</span><span class="typ">ToString</span><span class="pun">(</span><span class="typ">CultureInfo</span><span class="pun">.</span><span class="typ">InvariantCulture</span><span class="pun">)),</span><span class="pln"> doc</span><span class="pun">);</span></code></li><li class="L4"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L5"><code class=""></code></li><li class="L6"><code class=""><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">override</span><span class="pln"> </span><span class="typ">IIndexCriteria</span><span class="pln"> </span><span class="typ">GetIndexerData</span><span class="pun">(</span><span class="typ">IndexSet</span><span class="pln"> indexSet</span><span class="pun">)</span></code></li><li class="L7"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L8"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> indexCriteria </span><span class="pun">=</span><span class="pln"> indexSet</span><span class="pun">.</span><span class="typ">ToIndexCriteria</span><span class="pun">(</span><span class="typ">DataService</span><span class="pun">);</span></code></li><li class="L9"><code class=""><span class="pln">        </span><span class="kwd">return</span><span class="pln"> indexCriteria</span><span class="pun">;</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class=""></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">CollectCleanValues</span><span class="pun">(</span><span class="typ">Dictionary</span><span class="pun">&lt;</span><span class="kwd">string</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">string</span><span class="pun">&gt;</span><span class="pln"> fields</span><span class="pun">,</span><span class="pln"> </span><span class="typ">List</span><span class="str">&lt;string&gt;</span><span class="pln"> cleanValues</span><span class="pun">)</span></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> values </span><span class="pun">=</span><span class="pln"> fields</span><span class="pun">.</span><span class="typ">Values</span><span class="pun">;</span></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> value </span><span class="kwd">in</span><span class="pln"> values</span><span class="pun">)</span></code></li><li class="L6"><code class=""><span class="pln">            cleanValues</span><span class="pun">.</span><span class="typ">Add</span><span class="pun">(</span><span class="typ">CleanValue</span><span class="pun">(</span><span class="pln">value</span><span class="pun">));</span></code></li><li class="L7"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class=""></code></li><li class="L9"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> </span><span class="typ">CleanValue</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> value</span><span class="pun">)</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L1"><code class=""><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">HttpUtility</span><span class="pun">.</span><span class="typ">HtmlDecode</span><span class="pun">(</span><span class="pln">value</span><span class="pun">.</span><span class="typ">StripHtml</span><span class="pun">());</span></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class=""><span class="pun">}</span></code></li></ol></pre>

<p>To make it actually create an index you have to add it and an IndexSet to Examine's configuration. </p>
<p>/config/ExamineSettings.config:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="tag">&lt;Examine&gt;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="tag">&lt;ExamineIndexProviders&gt;</span></code></li><li class="L2"><code class=""><span class="pln">        </span><span class="tag">&lt;providers&gt;</span></code></li><li class="L3"><code class=""></code></li><li class="L4"><code class=""><span class="pln">                  </span><span class="com">&lt;!-- Existing providers... --&gt;</span></code></li><li class="L5"><code class=""></code></li><li class="L6"><code class=""><span class="pln">                  </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"SpellCheckIndexer"</span><span class="pln"> </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"YourAssembly.SpellCheckIndexer, YourAssembly"</span></code></li><li class="L7"><code class=""><span class="pln">                      </span><span class="atn">analyzer</span><span class="pun">=</span><span class="atv">"Lucene.Net.Analysis.Standard.StandardAnalyzer, Lucene.Net"</span></code></li><li class="L8"><code class=""><span class="pln">                  </span><span class="tag">/&gt;</span></code></li><li class="L9"><code class=""><span class="pln">        </span><span class="tag">&lt;/providers&gt;</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="tag">&lt;/ExamineIndexProviders&gt;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="com">&lt;!-- Search Providers - configured later --&gt;</span></code></li><li class="L2"><code class=""><span class="tag">&lt;/Examine&gt;</span></code></li></ol></pre>

<p>/config/ExamineIndex.config:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="tag">&lt;ExamineLuceneIndexSets&gt;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="tag">&lt;IndexSet</span><span class="pln"> </span><span class="atn">SetName</span><span class="pun">=</span><span class="atv">"SpellCheckIndexSet"</span><span class="pln"> </span><span class="atn">IndexPath</span><span class="pun">=</span><span class="atv">"~/App_Data/TEMP/ExamineIndexes/{machinename}/SpellCheck/"</span><span class="tag">&gt;</span></code></li><li class="L2"><code class=""><span class="pln">        </span><span class="tag">&lt;IndexAttributeFields&gt;</span></code></li><li class="L3"><code class=""><span class="pln">            </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">Name</span><span class="pun">=</span><span class="atv">"nodeName"</span><span class="tag">/&gt;</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="tag">&lt;/IndexAttributeFields&gt;</span></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="tag">&lt;IndexUserFields&gt;</span></code></li><li class="L6"><code class=""><span class="pln">            </span><span class="com">&lt;!-- Add the properties you want to extract words from here --&gt;</span></code></li><li class="L7"><code class=""><span class="pln">            </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">Name</span><span class="pun">=</span><span class="atv">"body"</span><span class="tag">/&gt;</span></code></li><li class="L8"><code class=""><span class="pln">            </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">Name</span><span class="pun">=</span><span class="atv">"summary"</span><span class="tag">/&gt;</span></code></li><li class="L9"><code class=""><span class="pln">            </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">Name</span><span class="pun">=</span><span class="atv">"description"</span><span class="tag">/&gt;</span></code></li><li class="L0"><code class=""><span class="pln">        </span><span class="tag">&lt;/IndexUserFields&gt;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="tag">&lt;/IndexSet&gt;</span></code></li><li class="L2"><code class=""><span class="tag">&lt;/ExamineLuceneIndexSets&gt;</span></code></li></ol></pre>

<p>Now we're actually ready to create a word index. Open the backoffice and the developer section. Navigate to the Examine Management tab. You should see the "SpellCheckIndexer". Click it and select "Index info &amp; tools". You might already have documents in the index. If so, we're good to go, otherwise click "Rebuild index". If you want, you can have a look at the data using <a href="http://www.getopt.org/luke/">Luke</a>.</p>
<p><img src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/luke.png" alt="Indexed terms shown with Luke"></p>
<h3>Casting the spell</h3>
<p>Now we're ready to let the Lucene Contrib <code>SpellChecker</code> do its magic. It needs to get the dictionary from our index, so let's give it a searcher from Exmine. We'll configure that as a regular searcher in ExamineSettings.config:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="tag">&lt;ExamineSearchProviders</span><span class="pln"> </span><span class="atn">defaultProvider</span><span class="pun">=</span><span class="atv">"ExternalSearcher"</span><span class="tag">&gt;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="tag">&lt;providers&gt;</span></code></li><li class="L2"><code class=""><span class="pln">        </span><span class="tag">&lt;add</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"SpellCheckSearcher"</span></code></li><li class="L3"><code class=""><span class="pln">            </span><span class="atn">type</span><span class="pun">=</span><span class="atv">"UmbracoExamine.UmbracoExamineSearcher, UmbracoExamine"</span></code></li><li class="L4"><code class=""><span class="pln">            </span><span class="atn">analyzer</span><span class="pun">=</span><span class="atv">"Lucene.Net.Analysis.Standard.StandardAnalyzer, Lucene.Net"</span></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="tag">/&gt;</span></code></li><li class="L6"><code class=""><span class="pln">    </span><span class="tag">&lt;/providers&gt;</span></code></li><li class="L7"><code class=""><span class="tag">&lt;/ExamineSearchProviders&gt;</span></code></li></ol></pre>

<p>Now we've got everything we need to build the checker. I've written some unit-tests for it, so the constructor takes a <code>BaseLuceneSearcher</code> as an argument. For testing, I just create one from an index I know exists. For Umbraco I instantiate it as a singleton using the searcher from Examine.</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span></code></li><li class="L1"><code class=""><span class="pun">{</span></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="kwd">object</span><span class="pln"> lockObj </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">();</span></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span><span class="pln"> instance</span><span class="pun">;</span></code></li><li class="L4"><code class=""><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span><span class="pln"> </span><span class="typ">Instance</span></code></li><li class="L5"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="kwd">get</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="pun">{</span></code></li><li class="L8"><code class=""><span class="pln">            </span><span class="kwd">lock</span><span class="pun">(</span><span class="pln">lockObj</span><span class="pun">)</span></code></li><li class="L9"><code class=""><span class="pln">            </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L0"><code class=""><span class="pln">                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instance </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span></code></li><li class="L1"><code class=""><span class="pln">                </span><span class="pun">{</span></code></li><li class="L2"><code class=""><span class="pln">                    instance </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span><span class="pun">((</span><span class="typ">BaseLuceneSearcher</span><span class="pun">)</span><span class="typ">ExamineManager</span><span class="pun">.</span><span class="typ">Instance</span><span class="pun">.</span><span class="typ">SearchProviderCollection</span><span class="pun">[</span><span class="str">"SpellCheckSearcher"</span><span class="pun">]);</span></code></li><li class="L3"><code class=""><span class="pln">                    instance</span><span class="pun">.</span><span class="typ">EnsureIndexed</span><span class="pun">();</span></code></li><li class="L4"><code class=""><span class="pln">                </span><span class="pun">}</span></code></li><li class="L5"><code class=""><span class="pln">            </span><span class="pun">}</span></code></li><li class="L6"><code class=""><span class="pln">            </span><span class="kwd">return</span><span class="pln"> instance</span><span class="pun">;</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L9"><code class=""></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="typ">BaseLuceneSearcher</span><span class="pln"> searchProvider</span><span class="pun">;</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="typ">SpellChecker</span><span class="pun">.</span><span class="typ">Net</span><span class="pun">.</span><span class="typ">Search</span><span class="pun">.</span><span class="typ">Spell</span><span class="pun">.</span><span class="typ">SpellChecker</span><span class="pln"> checker</span><span class="pun">;</span></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="typ">IndexReader</span><span class="pln"> indexReader</span><span class="pun">;</span></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln"> isIndexed</span><span class="pun">;</span></code></li><li class="L4"><code class=""></code></li><li class="L5"><code class=""><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span><span class="pun">(</span><span class="typ">BaseLuceneSearcher</span><span class="pln"> searchProvider</span><span class="pun">)</span></code></li><li class="L6"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">searchProvider </span><span class="pun">=</span><span class="pln"> searchProvider</span><span class="pun">;</span></code></li><li class="L8"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> searcher </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IndexSearcher</span><span class="pun">)</span><span class="pln">searchProvider</span><span class="pun">.</span><span class="typ">GetSearcher</span><span class="pun">();</span></code></li><li class="L9"><code class=""><span class="pln">        indexReader </span><span class="pun">=</span><span class="pln"> searcher</span><span class="pun">.</span><span class="typ">GetIndexReader</span><span class="pun">();</span></code></li><li class="L0"><code class=""><span class="pln">        checker </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">SpellChecker</span><span class="pun">.</span><span class="typ">Net</span><span class="pun">.</span><span class="typ">Search</span><span class="pun">.</span><span class="typ">Spell</span><span class="pun">.</span><span class="typ">SpellChecker</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RAMDirectory</span><span class="pun">(),</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">JaroWinklerDistance</span><span class="pun">());</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code class=""></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">EnsureIndexed</span><span class="pun">()</span></code></li><li class="L4"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">isIndexed</span><span class="pun">)</span></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L7"><code class=""><span class="pln">            checker</span><span class="pun">.</span><span class="typ">IndexDictionary</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">LuceneDictionary</span><span class="pun">(</span><span class="pln">indexReader</span><span class="pun">,</span><span class="pln"> </span><span class="str">"word"</span><span class="pun">));</span></code></li><li class="L8"><code class=""><span class="pln">            isIndexed </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L9"><code class=""><span class="pln">        </span><span class="pun">}</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class=""></code></li><li class="L2"><code class=""><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> </span><span class="typ">Check</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> value</span><span class="pun">)</span></code></li><li class="L3"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="typ">EnsureIndexed</span><span class="pun">();</span></code></li><li class="L5"><code class=""></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> existing </span><span class="pun">=</span><span class="pln"> indexReader</span><span class="pun">.</span><span class="typ">DocFreq</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Term</span><span class="pun">(</span><span class="str">"word"</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">));</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">existing </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L8"><code class=""><span class="pln">            </span><span class="kwd">return</span><span class="pln"> value</span><span class="pun">;</span></code></li><li class="L9"><code class=""></code></li><li class="L0"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> suggestions </span><span class="pun">=</span><span class="pln"> checker</span><span class="pun">.</span><span class="typ">SuggestSimilar</span><span class="pun">(</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> </span><span class="lit">10</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="str">"word"</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></code></li><li class="L1"><code class=""></code></li><li class="L2"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> jaro </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">JaroWinklerDistance</span><span class="pun">();</span></code></li><li class="L3"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> leven </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">LevenshteinDistance</span><span class="pun">();</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> ngram </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">NGramDistance</span><span class="pun">();</span></code></li><li class="L5"><code class=""></code></li><li class="L6"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> metrics </span><span class="pun">=</span><span class="pln"> suggestions</span><span class="pun">.</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">s </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="kwd">new</span></code></li><li class="L7"><code class=""><span class="pln">        </span><span class="pun">{</span></code></li><li class="L8"><code class=""><span class="pln">            word </span><span class="pun">=</span><span class="pln"> s</span><span class="pun">,</span></code></li><li class="L9"><code class=""><span class="pln">            freq </span><span class="pun">=</span><span class="pln"> indexReader</span><span class="pun">.</span><span class="typ">DocFreq</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Term</span><span class="pun">(</span><span class="str">"word"</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">)),</span></code></li><li class="L0"><code class=""><span class="pln">            jaro </span><span class="pun">=</span><span class="pln"> jaro</span><span class="pun">.</span><span class="typ">GetDistance</span><span class="pun">(</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">),</span></code></li><li class="L1"><code class=""><span class="pln">            leven </span><span class="pun">=</span><span class="pln"> leven</span><span class="pun">.</span><span class="typ">GetDistance</span><span class="pun">(</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">),</span></code></li><li class="L2"><code class=""><span class="pln">            ngram </span><span class="pun">=</span><span class="pln"> ngram</span><span class="pun">.</span><span class="typ">GetDistance</span><span class="pun">(</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">)</span></code></li><li class="L3"><code class=""><span class="pln">        </span><span class="pun">})</span></code></li><li class="L4"><code class=""><span class="pln">        </span><span class="pun">.</span><span class="typ">OrderByDescending</span><span class="pun">(</span><span class="pln">metric </span><span class="pun">=&gt;</span></code></li><li class="L5"><code class=""><span class="pln">            </span><span class="pun">(</span></code></li><li class="L6"><code class=""><span class="pln">                </span><span class="pun">(</span><span class="pln">metric</span><span class="pun">.</span><span class="pln">freq</span><span class="pun">/</span><span class="lit">100f</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span></code></li><li class="L7"><code class=""><span class="pln">                metric</span><span class="pun">.</span><span class="pln">jaro </span><span class="pun">+</span></code></li><li class="L8"><code class=""><span class="pln">                metric</span><span class="pun">.</span><span class="pln">leven </span><span class="pun">+</span></code></li><li class="L9"><code class=""><span class="pln">                metric</span><span class="pun">.</span><span class="pln">ngram</span></code></li><li class="L0"><code class=""><span class="pln">            </span><span class="pun">)</span></code></li><li class="L1"><code class=""><span class="pln">            </span><span class="pun">/</span><span class="pln"> </span><span class="lit">4f</span></code></li><li class="L2"><code class=""><span class="pln">        </span><span class="pun">)</span></code></li><li class="L3"><code class=""><span class="pln">        </span><span class="pun">.</span><span class="typ">ToList</span><span class="pun">();</span></code></li><li class="L4"><code class=""></code></li><li class="L5"><code class=""><span class="pln">        </span><span class="kwd">return</span><span class="pln"> metrics</span><span class="pun">.</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">m </span><span class="pun">=&gt;</span><span class="pln"> m</span><span class="pun">.</span><span class="pln">word</span><span class="pun">).</span><span class="typ">FirstOrDefault</span><span class="pun">();</span></code></li><li class="L6"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code class=""><span class="pun">}</span></code></li></ol></pre>

<p>The constructor keeps a reference to our word index and creates a SpellChecker that will do it's work in memory. When we first search for suggestions, <code>EnsureIndex</code> passes our word index to the <code>SpellChecker</code> and lets it create it's magic "back-end". It could also be on disk, but for this site the performance is good enough to do it live.</p>
<p>The only suggestion code you actually need in <code>Check</code> is basically just:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="pln">        </span><span class="kwd">var</span><span class="pln"> suggestion </span><span class="pun">=</span><span class="pln"> checker</span><span class="pun">.</span><span class="typ">SuggestSimilar</span><span class="pun">(</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></code></li></ol></pre>

<p>It will give you a feasible word if the value has a typo. However, in many cases it's not the one you're after. You can increase the number of suggestions you want to get a few more, but for search suggestions, we really just want one. Changing the <code>StringDistance</code> algorithm passed to the <code>SpellChecker</code> also varies the output, so you should experiment with that.</p>
<p>In my case there was a typo in the source data. I was testing against the Norwegian word for bathtub: "badekar". My test phrase was "badkear" and I kept getting suggestions for "badkar". That word snuck in there due to one spelling mistake in one document. So I figured word frequency should trump. But sorting the suggestions by word frequency turned out to be a bad idea. "Baderom", the Norwegian word for "bathroom", is more frequent and won over "badekar" that I was after.</p>
<p>I spun up all the string distance algorithms and put the results, including the document frequency of the terms in Excel. Experimenting a bit showed that the frequency divided by 100 added to the sum of the distance results was a good metric. After ordering by that result and taking the first, my checker is pretty intelligent when providing suggestions.</p>
<p><img src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/spellcheck_excel.png" alt="Evaluating algorithm with Excel"></p>
<h3>Getting results</h3>
<p>Here's a snippet from the search controller that builds up the response model:</p>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class=""><span class="kwd">var</span><span class="pln"> spellChecker </span><span class="pun">=</span><span class="pln"> </span><span class="typ">UmbracoSpellChecker</span><span class="pun">.</span><span class="typ">Instance</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L1"><code class=""><span class="kwd">var</span><span class="pln"> checkedTerms </span><span class="pun">=</span><span class="pln"> phrase</span><span class="pun">.</span><span class="typ">Split</span><span class="pun">(</span><span class="str">' '</span><span class="pun">).</span><span class="typ">Select</span><span class="pun">(</span><span class="pln">t </span><span class="pun">=&gt;</span><span class="pln"> spellChecker</span><span class="pun">.</span><span class="typ">Check</span><span class="pun">(</span><span class="pln">t</span><span class="pun">));</span></code></li><li class="L2"><code class=""><span class="kwd">var</span><span class="pln"> didYouMean </span><span class="pun">=</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="typ">Join</span><span class="pun">(</span><span class="str">" "</span><span class="pun">,</span><span class="pln"> checkedTerms</span><span class="pun">);</span></code></li><li class="L3"><code class=""><span class="pln">result</span><span class="pun">.</span><span class="typ">DidYouMean</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> didYouMean</span><span class="pun">;</span></code></li><li class="L4"><code class=""></code></li><li class="L5"><code class=""><span class="com">// Uses Lucene's TopScoreDocCollector</span></code></li><li class="L6"><code class=""><span class="kwd">var</span><span class="pln"> totalHits </span><span class="pun">=</span><span class="pln"> </span><span class="typ">GetTotalHits</span><span class="pun">(</span><span class="pln">query</span><span class="pun">);</span></code></li><li class="L7"><code class=""></code></li><li class="L8"><code class=""><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">result</span><span class="pun">.</span><span class="typ">DidYouMean</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> phrase</span><span class="pun">)</span></code></li><li class="L9"><code class=""><span class="pun">{</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">totalHits </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L1"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L2"><code class=""><span class="pln">        query </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CreateQuery</span><span class="pun">(</span><span class="pln">result</span><span class="pun">.</span><span class="typ">DidYouMean</span><span class="pun">);</span></code></li><li class="L3"><code class=""><span class="pln">        totalHits </span><span class="pun">=</span><span class="pln"> </span><span class="typ">GetTotalHits</span><span class="pun">(</span><span class="pln">query</span><span class="pun">);</span></code></li><li class="L4"><code class=""><span class="pln">        result</span><span class="pun">.</span><span class="typ">Modified</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L5"><code class=""><span class="pln">        result</span><span class="pun">.</span><span class="typ">Query</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="typ">DidYouMean</span><span class="pun">;</span></code></li><li class="L6"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code class=""><span class="pln">    </span><span class="kwd">else</span></code></li><li class="L8"><code class=""><span class="pln">    </span><span class="pun">{</span></code></li><li class="L9"><code class=""><span class="pln">        result</span><span class="pun">.</span><span class="typ">HasAlternative</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L0"><code class=""><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class=""><span class="pun">}</span></code></li></ol></pre>

<p>When searching for "badkear" now, I get <code>result.Modified == true</code>. I didn't get any hits for that word, but my spell checker found the word "badekar". I can happily go search for that and tell my user I modified his search. "Did not find any hits for 'badkear', showing results for 'badekar'.</p>
<p>When searching for "dujs", a misspelled version of the Norwegian word for "shower", I find that we have another typo in our data. I get <code>result.Modified == false</code>, but <code>result.HasAlternative == true</code>. My spell checker dutifully asks if I ment "dusj". "Showing 1 result. Did you mean 'dusj'?"</p>
<p><img src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/dujs.png" alt="Did you mean dusj?"></p>
<p>There's a lot more you can do with this to provide even more accurate suggestions. For my purposes however, this was all I needed. Leaning on Lucene Contrib when you need some fancy search functionality will almost always save the day. </p>
<p>If you want to know more about Lucene, I recommend getting the book called "Lucene in Action".</p>

        </section>

        <section class="share">
            <p class="info prompt">Share this post</p>
            <a href="http://twitter.com/share?text=Building%20a%20spell%20checker%20for%20search%20in%20Umbraco&amp;url=http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/" onclick="window.open(this.href, &#39;twitter-share&#39;, &#39;width=550,height=235&#39;);return false;">
                <i class="fa fa-2x fa-fw fa-twitter"></i> <span class="hidden">Twitter</span>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/" onclick="window.open(this.href, &#39;facebook-share&#39;,&#39;width=580,height=296&#39;);return false;">
                <i class="fa fa-2x fa-fw fa-facebook-square"></i> <span class="hidden">Facebook</span>
            </a>
            <a href="https://plus.google.com/share?url=http://blog.aabech.no/archive/building-a-spell-checker-for-search-in-umbraco/" onclick="window.open(this.href, &#39;google-plus-share&#39;, &#39;width=490,height=530&#39;);return false;">
                <i class="fa fa-2x fa-fw fa-google-plus-square"></i> <span class="hidden">Google+</span>
            </a>
        </section>

        <footer class="post-footer">

                <section class="author">
                    <p class="attr">Author</p>
                    <meta itemprop="publisher" content="Lars-Erik&#39;s blog">
                    <h4 itemprop="author">
Lars-Erik Aabech                    </h4>
                </section>

        </footer>
        
    <div id="disqus_thread"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 592px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>

    </article>

</main>


    <footer class="site-footer">
        <div class="inner">

            <section class="footer-description">
    Ramblings about Umbraco, .net and JavaScript development. With a sprinkle of other stuff.
</section>

            <section class="copyright">
                © 2016
                Lars-Erik Aabech. All rights reserved.
            </section>
            <section>
                Lars-Erik is currently employed as lead developer at <a href="http://www.markedspartner.no/" target="_blank">MarkedsPartner AS</a>.<br>
                MarkedsPartner is an Umbraco gold partner in Norway.
            </section>
            <section>Vapor theme by <a href="http://sethlilly.com/">Seth Lilly</a></section>

        </div>
    </footer>

    

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-77460036-1', 'blog.aabech.no');
  ga('send', 'pageview');
</script>

    


<iframe style="display: none;" src="./Building a spell checker for search in Umbraco - Lars-Erik&#39;s blog_files/saved_resource(1).html"></iframe><script aria-hidden="true" type="application/x-lastpass" id="hiddenlpsubmitdiv" style="display: none;"></script><script>try{(function() { for(var lastpass_iter=0; lastpass_iter < document.forms.length; lastpass_iter++){ var lastpass_f = document.forms[lastpass_iter]; if(typeof(lastpass_f.lpsubmitorig2)=="undefined"){ lastpass_f.lpsubmitorig2 = lastpass_f.submit; if (typeof(lastpass_f.lpsubmitorig2)=='object'){ continue;}lastpass_f.submit = function(){ var form=this; var customEvent = document.createEvent("Event"); customEvent.initEvent("lpCustomEvent", true, true); var d = document.getElementById("hiddenlpsubmitdiv"); if (d) {for(var i = 0; i < document.forms.length; i++){ if(document.forms[i]==form){ if (typeof(d.innerText) != 'undefined') { d.innerText=i.toString(); } else { d.textContent=i.toString(); } } } d.dispatchEvent(customEvent); }form.lpsubmitorig2(); } } }})()}catch(e){}</script></body></html>