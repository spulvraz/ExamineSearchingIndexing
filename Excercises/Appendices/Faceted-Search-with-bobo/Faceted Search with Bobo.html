<!DOCTYPE html>
<!-- saved from url=(0047)http://24days.in/umbraco/2014/search-with-bobo/ -->
<html lang="en" class="wf-proximanova-n7-active wf-lemondejournal-n4-active wf-lemondejournal-i4-active wf-lemondejournal-n7-active wf-proximanova-i7-active wf-proximanova-n4-active wf-proximanova-i4-active wf-lemondejournal-i7-active wf-active"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<!--Umbraco-->
<title>Faceted Search with Bobo</title>
<meta name="description" content="Learn to use Bobo for faceted search in your Umbraco sites.">
<!--[if ! lte IE 8]><!-->
<link rel="stylesheet" href="./Faceted Search with Bobo_files/app.css">
<!--<![endif]-->
<!--[if lte IE 8]>
			<link rel="stylesheet" href="/assets/U0X0/ie.css">
			<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	    <![endif]--><link rel="alternate" href="http://24days.in/umbraco/2014/rss" type="application/rss+xml"><script type="text/javascript" async="" src="./Faceted Search with Bobo_files/ga.js"></script><script type="text/javascript" src="./Faceted Search with Bobo_files/uaj4zeg.js"></script>
<style type="text/css">.tk-proxima-nova{font-family:"proxima-nova",sans-serif;}.tk-lemonde-journal{font-family:"lemonde-journal",serif;}</style><style type="text/css">@font-face{font-family:proxima-nova;src:url(https://fonts.typekit.net/af/590c05/00000000000000000001499c/23/l?subset_id=2&fvd=n7) format("woff2");font-weight:700;font-style:normal;}@font-face{font-family:proxima-nova;src:url(https://fonts.typekit.net/af/1f2c3f/0000000000000000000148a9/23/l?subset_id=2&fvd=i7) format("woff2");font-weight:700;font-style:italic;}@font-face{font-family:proxima-nova;src:url(https://fonts.typekit.net/af/810327/0000000000000000000148a4/23/l?subset_id=2&fvd=n4) format("woff2");font-weight:400;font-style:normal;}@font-face{font-family:proxima-nova;src:url(https://fonts.typekit.net/af/8e5830/0000000000000000000148a5/23/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}@font-face{font-family:lemonde-journal;src:url(https://fonts.typekit.net/af/8845c7/00000000000000000000d8dc/23/l?subset_id=2&fvd=n4) format("woff2");font-weight:400;font-style:normal;}@font-face{font-family:lemonde-journal;src:url(https://fonts.typekit.net/af/a0fe7e/00000000000000000000d8dd/23/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}@font-face{font-family:lemonde-journal;src:url(https://fonts.typekit.net/af/8b93a1/00000000000000000000d8de/23/l?subset_id=2&fvd=n7) format("woff2");font-weight:700;font-style:normal;}@font-face{font-family:lemonde-journal;src:url(https://fonts.typekit.net/af/123bae/00000000000000000000d8df/23/l?subset_id=2&fvd=i7) format("woff2");font-weight:700;font-style:italic;}</style><script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://24days.in/assets/U0X0/24days-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://24days.in/assets/U0X0/24days-144x144.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-title" content="Umbraco 24"><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11788998-5']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
	
<script type="text/javascript" async="" src="./Faceted Search with Bobo_files/embed.js"></script></head>
<body class="nav-collapsed">
	




	<nav>
  <div class="trigger">Menu</div>
  <div class="folder d25 collapsed">
    <ul>
      <li>
        <a href="http://24days.in/umbraco/about/" title="What is this thing?">?</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/epub/" title="The EPUB is here">+</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/card-modes/" title="The power of (Christmas) card modes">24</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/the-merchello-contribution/" title="The Merchello Contribution">23</a>
      </li>
      <li class="selected">
        <a href="http://24days.in/umbraco/2014/search-with-bobo/" title="Faceted Search with Bobo">22</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/redirect-rules/" title="Redirect rules">21</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/extending-umbraco-7-backend/" title="Extending Umbraco 7 backend">20</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/umbraco-tribe/" title="Have beer - looking for workers">19</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/packaging-with-appveyor/" title="Umbraco Packaging with AppVeyor CI">18</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/urlprovider-and-contentfinder/" title="Modify Umbraco URLs with the UrlProvider and ContentFinder">17</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/all-your-images-are-belong-to-umbraco/" title="All Your Images Are Belong to Umbraco">16</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/razor-language-switcher/" title="Build a simple contextual language switcher">15</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/umbraco-angular-tips/" title="Using Angular in the backoffice - Some useful tips">14</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/iocdi-architecture/" title="Architecture based on IoC/DI for Umbraco packages">13</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/upgrading-umbraco-using-git/" title="Upgrading Umbraco using Git">12</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/how-to-set-up-an-umbraco-site/" title="Newbie&#39;s Guide to Setting Up an Umbraco Website">11</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/grid-macros/" title="How to take full advantage of macros within the Umbraco 7.2 grid">10</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/architectural-thoughts/" title="Architectural thoughts when using Umbraco in Multi-platform solutions">09</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/angular-powered-frontend/" title="Making an Angular-powered frontend with Umbraco">08</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/managing-members/" title="Managing Members in Umbraco">07</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/the-double-album/" title="The Double Album">06</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/dealing-with-members/" title="Dealing With Members Using The MemberService &amp; MembershipHelper">05</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/your-first-pull-request/" title="Your first pull request">04</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/working-with-complex-archetype-datatypes/" title="Getting data in and out of complex Archetype data types">03</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/debugging-angularjs/" title="Debugging AngularJS">02</a>
      </li>
      <li>
        <a href="http://24days.in/umbraco/2014/traveller-guide/" title="The Umbraco Codebase: A Traveller&#39;s Guide">01</a>
      </li>
    </ul>
  </div>
</nav>
	<article><header><div class="tags"><a href="http://24days.in/umbraco/tags/search/" rel="tag" title="See all articles tagged with Search">search</a> <a href="http://24days.in/umbraco/tags/v7/" rel="tag" title="See all articles tagged with v7">v7</a> </div>
    <h1>Faceted Search with Bobo</h1>
    <div class="byline">â€” by Antony Briggs</div></header><div class="text"><h2>Introduction</h2>
<p>Who hasn't had a client say "build me a search function like eBay (or Amazon, Ebuyer etc.)"?</p>
<p>Usually the client has no idea of the scale of the request they've just made but as we'll find out, Bobo does a pretty good job of handling it all.</p>
<h2>Why facet with Bobo?</h2>
<p>Good question! The core Lucene project (that powers Examine) comes with built-in faceting <strong>but</strong>&nbsp;that's written in Java. The .net port is a little behind the times (version 3.0.3 to be precise and we don't see true Faceting until version 3.4 or so)</p>
<p>Examine also has its own implementation of faceting but it's in an experimental branch and so requires re-compiling Examine (and potentially keeping it up to date with future Umbraco releases)</p>
<p>As we'll see,&nbsp;<a href="http://senseidb.github.io/bobo/" target="_blank">Bobo</a>&nbsp;is not just a Faceting engine. It basically provides everything you need to create a browse-driven web experience.</p>
<p>In their own words:</p>
<blockquote>
<p>"Bobo Browse is an information retrieval technology that provides navigational browsing into a semi-structured dataset. Beyond the result set from queries and selections, Bobo Browse also provides the facets from this point of browsing."</p>
</blockquote>
<p>Features:</p>
<ol>
<li><em>No need for cache warm-up for the system to perform:</em> Good for low-traffic sites</li>
<li><em>multi value sort - sort documents on fields that have multiple values per doc, .e.g tokenized fields:</em> This is only useful if you implement your own LuceneIndexer.DocumentWriting Event Handler.</li>
<li><em>fast field value retrieval:</em> You can fetch the search results directly from Bobo, avoiding an Umbraco Content lookup if you need maximum speed (I don't personally do this - assuming you've implemented pagination Umbraco will barely feel a tickle)</li>
<li><em>facet count distribution analysis:&nbsp;</em> Erm? Answers on a postcard?</li>
<li><em>stable and small memory footprint:</em> Good.</li>
<li><em>support for runtime faceting:</em> See point 4.</li>
</ol>
<p>As an aside: A discussion of faceting wouldn't be complete without touching upon <a href="http://www.eduserv.org.uk/blog/2011/09/26/faceted-search-using-solr-what-it-is-and-what-benefits-does-it-provide/" target="_blank">Solr</a>. &nbsp;Similar to Bobo, Solr imposes a structure on your data via a Schema and allows you to search sort and facet all kinds of document-orientated data. But this requires a not-insignificant investment of time to keep the Solr index in-sync with your Umbraco content - something that Examine handles for free.</p>
<h2>Build Bobo</h2>
<p>Now this may look like a lot of effort, but stick with me, it'll be worth it in the end.</p>
<p>Until Umbraco Examine is updated to use version 3.0.3 of Lucene, we need to use the old, and slightly un-loved, version of Bobo. This requires a little work but I've detailed the steps below:</p>
<ul>
<li><a href="https://bobo.codeplex.com/SourceControl/latest%20-%20for%20Lucene%202">https://bobo.codeplex.com/SourceControl/latest</a>&nbsp;- for Lucene 2.9</li>
<li><a href="https://github.com/zhengchun/Bobo-Browse.Net">https://github.com/zhengchun/Bobo-Browse.Net</a> - for Lucene 3.0.3</li>
</ul>
<p>Download a zip of the source code. Don't open the solution in visual studio yet!&nbsp; We need to replace the log4net.dll in \DllReferences with the one from the Umbraco distribution first. This done, open the solution in visual studio (I used vs2010, if you have a newer version it will likely want to update the project) then right-click properties on each of the three projects in the solution in turn (BoboBrowse.Net, BoboBrowse.Tests &amp; LuceneExt.Net) and change:</p>
<ol>
<li>The Target Framework to (at least) version 4 (not client profile)</li>
<li>Uncheck the "Sign the assembly" check box on the "Signing" tab - The version of log4net that ships with Umbraco isn't signed so in turn, Bobo can't be signed.</li>
</ol>
<p>Finally, build the solution and you will have a shiny BoboBrowse.Net.dll (&amp; friends) in the \Deployment folder.</p>
<p>Copy the contents of this folder to the \bin folder of Umbraco and reload the admin area.</p>
<h2>The Demo</h2>
<p>I've put together a little demo based on the TXT starter Kit for Umbraco (this demo was written for u7.1.9 but the version of Lucene shipped with Umbraco has been stable for ages so the core concepts will work on any version of Umbraco 4.7+)</p>
<p>Let's start with adding some content that we can facet on. I've added a property to the News Item Document Type called Category:</p>
<p><img src="./Faceted Search with Bobo_files/Add_Property_498x335.jpg" width="498" height="335" alt="Add Property"></p>
<p>And then populated each news article with some sample categories:</p>
<p><img src="./Faceted Search with Bobo_files/Populate_Property_498x149.jpg" width="498" height="149" alt="Populate Property"></p>
<p>What we're aiming for is a search page with a keyword search plus our Category facet a little like this:</p>
<p><img src="./Faceted Search with Bobo_files/NoQuery_500x280.jpg" width="500" height="280" alt="Noquery"></p>
<p>I sincerely hope yours will be prettier!</p>
<h2>The Code</h2>
<p>Most of the following is just a re-spun version of the usage sample from the projects' home page at <a href="https://bobo.codeplex.com/">https://bobo.codeplex.com/</a> with a sprinkling of configuration from my last project.</p>
<p>Let's start by building a BrowseRequest.</p>
<pre class=" language-csharp"><code class=" language-csharp"><span class="token comment" spellcheck="true">// creating a browse request</span>
<span class="token keyword">var</span> browseRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowseRequest</span>
<span class="token punctuation">{</span>
    Count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Page size</span>
    Offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Page size * Page Number</span>
    FetchStoredFields <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Fetch data from stored fields</span>
    Sort <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">SortField</span><span class="token punctuation">(</span><span class="token string">"updateDate"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>As you can see, Bobo handles all the logic efficiently paging through your result set, all you need to do it specify a page size and build a pagination UI (Not covered in this demo)</p>
<p>Next, we'll add in the keyword search provided by the user. This will be interpreted as a raw <a href="http://lucene.apache.org/core/2_9_4/queryparsersyntax.html" target="_blank">Lucene Query</a>&nbsp;so you may want to sanitise the user's input a little. <a href="https://gist.github.com/abriggs-eduserv/01673d2f847b30395c0d" target="_blank">Here's one I created earlier</a>.</p>
<pre class=" language-csharp"><code class=" language-csharp"><span class="token comment" spellcheck="true">// parse a query</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> Request<span class="token punctuation">[</span><span class="token string">"q"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty<span class="token punctuation">(</span></span>query<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lucene<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>QueryParsers<span class="token punctuation">.</span>QueryParser</span><span class="token punctuation">(</span>Lucene<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Version<span class="token punctuation">.</span>LUCENE_29<span class="token punctuation">,</span> <span class="token string">"bodyText"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Lucene<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Analysis<span class="token punctuation">.</span>KeywordAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Query q <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">Parse<span class="token punctuation">(</span></span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    browseRequest<span class="token punctuation">.</span>Query <span class="token operator">=</span> q<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Here's where I deviate from the Bobo sample usage - Each facet requires two entities in Bobo, a FacetHandler and a FacetSpec. I chose to initialise them both at the same time as follows:</p>
<pre class=" language-csharp"><code class=" language-csharp">ICollection<span class="token operator">&lt;</span>FacetHandler<span class="token operator">&gt;</span> handlerList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>FacetHandler<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// define the facet output spec used for all facets</span>
<span class="token keyword">var</span> facetSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FacetSpec</span> <span class="token punctuation">{</span> OrderBy <span class="token operator">=</span> FacetSpec<span class="token punctuation">.</span>FacetSortSpec<span class="token punctuation">.</span>OrderHitsDesc<span class="token punctuation">,</span> ExpandSelection <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Add a facet</span>
<span class="token keyword">var</span> fieldName <span class="token operator">=</span> <span class="token string">"category"</span><span class="token punctuation">;</span>
handlerList<span class="token punctuation">.</span><span class="token function">Add<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">SimpleFacetHandler</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
browseRequest<span class="token punctuation">.</span><span class="token function">SetFacetSpec<span class="token punctuation">(</span></span>fieldName<span class="token punctuation">,</span> facetSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The chosen FacetHandler specifies the general behaviour of the Facet. For example you can use a RangeFacetHandler() to facet on pre-defined ranges e.g. price ranges or date ranges. Here we're using the SimpleFacetHandler which expects a single value per document (a category in this example). If you were able to select multiple categories then you would need to upgrade to the MultiValueFacetHandler.</p>
<p>Now we stick it all together by:</p>
<ol>
<li>Grabbing an Examine Searcher for the built-in 'External' index.</li>
<li>Then grabbing the underlying Lucene IndexSearcher.</li>
<li>Extracting the IndexReader which is what Bobo will operate on.&nbsp;</li>
<li><span>Wrapping the vanilla IndexReader with a BoboIndexReader.</span></li>
<li><span>Executing the browse request we've built up.</span></li>
</ol>
<pre class=" language-csharp"><code class=" language-csharp"><span class="token keyword">var</span> searchProvider <span class="token operator">=</span> ExamineManager<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>SearchProviderCollection<span class="token punctuation">[</span><span class="token string">"ExternalSearcher"</span><span class="token punctuation">]</span> <span class="token keyword">as</span> LuceneSearcher<span class="token punctuation">;</span>
<span class="token keyword">var</span> searcher <span class="token operator">=</span> <span class="token punctuation">(</span>IndexSearcher<span class="token punctuation">)</span> searchProvider<span class="token punctuation">.</span><span class="token function">GetSearcher<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> reader <span class="token operator">=</span> searcher<span class="token punctuation">.</span><span class="token function">GetIndexReader<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// decorate lucene reader with a bobo index reader</span>
BoboIndexReader boboReader <span class="token operator">=</span> BoboIndexReader<span class="token punctuation">.</span><span class="token function">GetInstance<span class="token punctuation">(</span></span>reader<span class="token punctuation">,</span> handlerList<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// perform browse</span>
IBrowsable browser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoboBrowser</span><span class="token punctuation">(</span>boboReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> results <span class="token operator">=</span> browser<span class="token punctuation">.</span><span class="token function">Browse<span class="token punctuation">(</span></span>browseRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This will result in a list of Lucene documents that matches your query.</p>
<p>As lucene documents consist of Key-Value pairs of string data, they're not the nicest things to work with, especially when we have the awesome Umbraco at our fingertips. So the following step will extract the NodeIds of the matching documents (only for the current page if there are a lot of matches) and fetch lovely Umbraco Dynamic content items for us to razor all over!</p>
<pre class=" language-csharp"><code class=" language-csharp"><span class="token comment" spellcheck="true">// create collection of Umbraco NodeIds from Hits.</span>
<span class="token keyword">var</span> resultNodeIds <span class="token operator">=</span> results<span class="token punctuation">.</span>Hits<span class="token punctuation">.</span><span class="token function">Select<span class="token punctuation">(</span></span>x <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>StoredFields<span class="token punctuation">.</span><span class="token function">Get<span class="token punctuation">(</span></span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2>HTML</h2>
<p>I suspect most people reading this will have a fair idea of how they want their search results to look so I'll keep this brief.</p>
<pre class=" language-markup"><code class=" language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>9u<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>q<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>q<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>q<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@Request[<span class="token punctuation">"</span></span><span class="token attr-name">q</span>"]" <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Search<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3u<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            @foreach (var facet in results.FacetMap)
            {
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>@facet.Key<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
                    @foreach (var facetValue in facet.Value.GetFacets())
                    {
                        var chck = (Request["facet_" + facet.Key] ?? string.Empty).Contains(@facetValue.Value.ToString()) ? "selected" : null;
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>facet_@facet.Key<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@facetValue.Value<span class="token punctuation">"</span></span> <span class="token attr-name">checked</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@chck<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>@facetValue.Value<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>: @facetValue.HitCount<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
                    }
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
            }
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Update<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6u<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
            @foreach (var resultNodeId in resultNodeIds)
            {
                var node = Umbraco.Content(resultNodeId);
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@node.Url<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>@node.Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            }
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

</code></pre>
<p>In this snippet, I've:</p>
<ol>
<li>Iterated over the available facets, generating a checkbox for each and then,</li>
<li>Iterated over the search results, outputting a link to the page.</li>
</ol>
<p>It isn't pretty, it's not even clever. OK, there's no need to laugh!</p>
<figure>
  <a href="./Faceted Search with Bobo_files/loremquery.png">
    <img src="./Faceted Search with Bobo_files/loremquery.png" width="454" alt="Searching the demo for keyword &#39;Lorem&#39;">
  </a>
  <figcaption>Searching the demo for keyword 'Lorem'</figcaption>
</figure>
<h2>Filtering</h2>
<p>Now that we have checkboxes to let the user filter by the available facets, we need to pass their selections on to Bobo.&nbsp;</p>
<pre class=" language-csharp"><code class=" language-csharp"><span class="token comment" spellcheck="true">// read facet selections from the form post</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token keyword">string</span> key <span class="token keyword">in</span> Request<span class="token punctuation">.</span>Form<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">StartsWith<span class="token punctuation">(</span></span><span class="token string">"facet_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> facet <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">Substring<span class="token punctuation">(</span></span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// add a selection</span>
    BrowseSelection sel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowseSelection</span><span class="token punctuation">(</span>facet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sel<span class="token punctuation">.</span><span class="token function">AddValue<span class="token punctuation">(</span></span>Request<span class="token punctuation">.</span>Form<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    browseRequest<span class="token punctuation">.</span><span class="token function">AddSelection<span class="token punctuation">(</span></span>sel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Here we're simply:</p>
<ol>
<li>Iterating over the Form collection</li>
<li>Picking out the facet selections and</li>
<li>Dumping them straight into the BrowseRequest.</li>
</ol>
<p>It really couldn't be simpler!</p>
<figure>
  <a href="./Faceted Search with Bobo_files/loremqueryplusfilter.png">
    <img src="./Faceted Search with Bobo_files/loremqueryplusfilter.png" width="465" alt="Filtering the news articles by category. As if you needed proof!">
  </a>
  <figcaption>Filtering the news articles by category. As if you needed proof!</figcaption>
</figure>
<p><a href="https://gist.github.com/abriggs-eduserv/c23f4a0ffc28b5afebd5" target="_blank">You can find the complete demo macro partial here</a>.</p>
<h2>Wrapping Up</h2>
<p>Whilst this has been a whistle stop tour of bobo, we have built up a fully-functional search page with faceting. However, there are some subtleties that we haven't touched upon, such as how the Analyser used to build the Index has a big impact on the behaviour of the faceting (e.g. the External index uses a StandardAnalyser by default and that is the reason that the facets appear in lowercase in the screenshots above).</p>
<p>Hopefully I've whetted your appetite enough to want to continue reading about Bobo and/or Lucene, the technology that underpins Examine. Enjoy!</p>
<ul>
<li><a href="https://code.google.com/p/bobo-browse/">https://code.google.com/p/bobo-browse/</a></li>
<li><a href="https://bobo.codeplex.com/">https://bobo.codeplex.com/</a></li>
<li><a href="https://github.com/zhengchun/Bobo-Browse.Net">https://github.com/zhengchun/Bobo-Browse.Net</a></li>
<li><a href="https://gist.github.com/abriggs-eduserv/c23f4a0ffc28b5afebd5">https://gist.github.com/abriggs-eduserv/c23f4a0ffc28b5afebd5</a></li>
</ul></div><footer><div class="gravatar" title="Antony Briggs"><img src="./Faceted Search with Bobo_files/592ae36b9bd2f14ec37223d479eb897b.jpg" width="100" height="100"></div>
    <h1>Antony Briggs</h1>
    <p>Antony is on Twitter as <a href="http://twitter.com/antonybriggs" title="Antony Briggs on Twitter" rel="author">@antonybriggs</a></p></footer></article>
	<section class="comments">
  <div id="disqus_thread"><iframe id="dsq-app2" name="dsq-app2" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Faceted Search with Bobo_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 7282px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
  <script type="text/javascript">
					var disqus_title = 'Faceted Search with Bobo';
					var disqus_identifier = '24DaysInUmbraco_umb1888';
					var disqus_url = 'http://24days.in/umbraco/2014/search-with-bobo/';
					(function() {
		                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		                dsq.src = 'http://24daysinumbraco.disqus.com/embed.js';
		                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		            })();
				</script>
  <noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>
  
</section>
	




<script>
		document.write('<script src=\/assets\/U0X0\/' +
		('__proto__' in {} ? 'zepto' : 'jquery') +
		'-min.js><\/script>')
		</script><script src="./Faceted Search with Bobo_files/zepto-min.js"></script><script src="./Faceted Search with Bobo_files/libs-min.js"></script><script src="./Faceted Search with Bobo_files/app.js"></script>



</body></html>